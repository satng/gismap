<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>gisMap.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <li class="nav-link nav-home-link"><a href="index.html">Home</a></li><li class="nav-heading">Classes</li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="GisMap.html">GisMap</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="GisMap.html#.addCameraEvent">addCameraEvent</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="GisMap.html#.addMouseEvent">addMouseEvent</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="GisMap.html#.getCameraHeight">getCameraHeight</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="GisMap.html#.getCameraPosition">getCameraPosition</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="GisMap.html#.removeCameraEvent">removeCameraEvent</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="GisMap.html#.removeMouseEvent">removeMouseEvent</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="GisMap.html#.setSceneMode2D3D">setSceneMode2D3D</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="GisMap.html#.zoomIn">zoomIn</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="GisMap.html#.zoomOut">zoomOut</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="GisMap.html#clearWeather">clearWeather</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="GisMap.html#drawAnimateLine">drawAnimateLine</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="GisMap.html#drawPoint">drawPoint</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="GisMap.html#remove">remove</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="GisMap.html#setView">setView</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="GisMap.html#setWeather">setWeather</a></span></li><li class="nav-heading"><a href="global.html">Globals</a></li>
</nav>

<div id="main">
    
    <h1 class="page-title">gisMap.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import * as Cesium from '@modules/cesium/Source/Cesium';
import baseOptions from '../config/base';
import { getPointOptions, getLabelOptions } from './entity';
import Weather from './weather/index';
import Tip from './common/tip';
import Menu from './common/menu';
import material from './material/line';
import material2 from './material/polyline';
import { computeCircle } from './utils';
import camera from './methods/camera';
import mouse from './methods/mouse';
import base from './methods/base';
import '@modules/cesium/Source/Widgets/widgets.css';

material(Cesium);
material2(Cesium);

window.CESIUM_BASE_URL = '/static/Cesium';
Cesium.Ion.defaultAccessToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiIzZGE5MmI2Yy1jZmVmLTQyZGUtYjk4Ni02ODBiYWFiZDZkOGYiLCJpZCI6MjU3MDQsInNjb3BlcyI6WyJhc3IiLCJnYyJdLCJpYXQiOjE1ODY0MjQyMDR9.dx-BAVwhWMWfgJb49x2XZEVP-EjFxMvihn8Lca6EXYU';

// id 累加计数器
let _id = 1;

class GisMap {
  static version = '1.0.0';

  Cesium = Cesium;

  /**
   *
   * @param {Element | String} container
   * @param {Viewer.ConstructorOptions} options cesium Viewer.ConstructorOptions
   * @return {gisMap} gisMap gisMap实例
   */
  constructor(container, options) {
    this.viewer = null;
    this.scene = null;
    this.camera = null;
    // 天气
    this.weather = null;
    // 选中元素
    this.selected = null;
    // tip 对象
    this.tip = null;
    // 右键菜单
    this.contextMenu = null;
    //  事件中心
    this.eventCenter = {};
    this.init(container, options);
  }

  init(container, options) {
    this.initViewer(container, options);
  }

  initViewer(container, options = {}) {
    this.viewer = new Cesium.Viewer(container, { ...baseOptions, ...options });
    this.scene = this.viewer.scene;
    this.camera = this.viewer.camera;
    this.viewer.scene.globe.depthTestAgainstTerrain = true;
    // 开启抗锯齿
    // this.scene.fxaa = true;
    // this.scene.postProcessStages.fxaa.enabled = true;
    // 图像渲染像素化处理
    // if (Cesium.FeatureDetection.supportsImageRenderingPixelated()) {
    //   this.viewer.resolutionScale = window.devicePixelRatio;
    // }
    // http://127.0.0.1:8001/geoserver/my_china/wms?SERVICE=WMS&amp;VERSION=1.1.1&amp;REQUEST=GetMap&amp;FORMAT=image%2Fjpeg&amp;TRANSPARENT=true&amp;STYLES&amp;LAYERS=my_china%3AHYP_HR&amp;exceptions=application%2Fvnd.ogc.se_inimage&amp;SRS=EPSG%3A4326&amp;WIDTH=768&amp;HEIGHT=384&amp;BBOX=73.212890625%2C40.78125%2C106.962890625%2C57.65625
    // viewer.scene.imagerySplitPosition = 0.1;
    // 去除版权信息
    this.viewer.cesiumWidget.creditContainer.style.display = 'none';
    // 太阳光线
    this.viewer.scene.globe.enableLighting = false;
    // 开启阴影效果
    this.viewer.shadows = false;
    // 展示太阳
    // this.scene.sun.show = true;
    // 太阳变大
    // this.scene.sun.glowFactor = 10;
    // 展示月亮
    // this..scene.moon.show = true;
    // 取消双击事件
    // this.setView({ longitude: 100, latitude: 20, height: 10000000 });
    this.viewer.cesiumWidget.screenSpaceEventHandler.removeInputAction(Cesium.ScreenSpaceEventType.LEFT_DOUBLE_CLICK);
    this.viewer.cesiumWidget.screenSpaceEventHandler.removeInputAction(Cesium.ScreenSpaceEventType.LEFT_CLICK);
    this._handleEvent();
  }

  // loadScene() {
  //   const tileset = new Cesium.Cesium3DTileset({
  //     url: Cesium.IonResource.fromAssetId(40866),
  //   });
  // }

  _handleEvent() {
    const handler = new Cesium.ScreenSpaceEventHandler(this.scene.canvas);
    handler.setInputAction((movement) => {
      const windowPosition = movement.position;
      const pick = this.viewer.scene.pick(windowPosition);
      if (pick) {
        this.handleTip(pick);
      } else {
        this.unHandleTip();
        this.unHandleMenu();
      }
    }, Cesium.ScreenSpaceEventType.LEFT_CLICK);

    handler.setInputAction((movement) => {
      const windowPosition = movement.position;
      const pick = this.viewer.scene.pick(windowPosition);
      if (pick) {
        this.handleMenu(pick);
      } else {
        this.unHandleTip();
        this.unHandleMenu();
      }
    }, Cesium.ScreenSpaceEventType.RIGHT_CLICK);
  }

  /**
   *
   * 设置视角（相机位置）
   * @param {position} data
   * @memberof GisMap
   * @return {GisMap} gismap
   */
  setView(data) {
    const {
      longitude,
      latitude,
      height,
      heading = 0.0,
      pitch = -90.0,
      roll = 0.0,

    } = data;
    if (data) {
      this.camera.setView({
        // 设置相机位置
        destination: Cesium.Cartesian3.fromDegrees(longitude, latitude, height),
        orientation: {
          // 初始视角
          heading: Cesium.Math.toRadians(heading),
          pitch: Cesium.Math.toRadians(pitch),
          roll: Cesium.Math.toRadians(roll),
        },
      });
    }
    return this;
  }

  setDefaultPosition(data) {
    this.setView(data);
    // const {longitude, latitude, height} = data
    // if(data){
    //   const center = Cesium.Cartesian3.fromDegrees(longitude, latitude,height);
    //   this.camera.lookAt(center,  new Cesium.HeadingPitchRange(0.01, Cesium.Math.toRadians(-90.0), 0.01))
    // }
  }

  /**
   *
   * 绘制动态线段
   * @param {Point[]} points
   * @param {Object} [options={}]
   * @memberof GisMap
   * @returns {*}
   */
  drawAnimateLine(points, options = {}) {
    _id += 1;
    if (points.length &lt; 2) {
      return;
    }

    const pointsArray = points.reduce((a, b) => a.concat(b), []);
    const entity = new Cesium.Entity({
      id: Number.prototype.toString.apply(_id),
      // show: true,
      // tip:{show:true,content:'这是线段'},
      width: 2,
      ...options,
      polyline: {
        positions: Cesium.Cartesian3.fromDegreesArrayHeights(pointsArray),
        // material:  Cesium.Material.fromType(Cesium.Material.PolylineTrailLinkType),
        material: new Cesium.PolylineTrailLinkMaterialProperty(
          Cesium.Color.fromCssColorString(options.color || '#0099cc'),
          2000,
        ),
        arcType: Cesium.ArcType.GEODESIC,
        // clampToGround: true,
      },
    });

    const line = this.viewer.entities.add(entity);

    return line;
  }

  /**
   *
   * 绘制线段
   * @param {Point[]} points
   * @param {Object} [options={}]
   * @memberof GisMap
   * @returns {*}
   */
  drawLine = (points = [], options = {}) => {
    if (points.length &lt; 2) {
      return;
    }

    const pointsArray = points.reduce((a, b) => a.concat(b), []);
    _id += 1;
    const entity = new Cesium.Entity({
      id: Number.prototype.toString.apply(_id),
      // show: true,
      // tip:{show:true,content:'这是线段'},
      width: 2,
      ...options,
      polyline: {
        positions: Cesium.Cartesian3.fromDegreesArrayHeights(pointsArray),
        // eslint-disable-next-line new-cap
        material: new Cesium.Color.fromCssColorString(options.color || '#0099cc'),
        arcType: Cesium.ArcType.GEODESIC,
        // clampToGround: true,
      },
    });
    this.viewer.entities.add(entity);
    return entity;
  };

  /**
 *
 * 点绘制
 * @param {object} data
 * @returns {entity} entity
 * @memberof GisMap
 */
  drawPoint(data) {
    const {
      longitude,
      latitude,
      height,
      key,
      name,
      pixelSize,
      label,
      tip,
      menu,
    } = data;

    const pointOption = getPointOptions(data);
    const lableOptiopns = getLabelOptions({
      ...label,
      pixelSize,
    });
    _id += 1;
    const entity = new Cesium.Entity({
      name,
      id: key || Number.prototype.toString.apply(_id),
      show: true,
      position: Cesium.Cartesian3.fromDegrees(longitude, latitude, height),
      point: pointOption,
      label: lableOptiopns,
      tip,
      menu,
    });
    this.viewer.entities.add(entity);
    return entity;
  }

  /**
   *
   * 设置天气
   * @param {'rain'| 'snow' |'fog'} weather  设置 雨、雪、雾
   * @memberof GisMap
   */
  setWeather(weather) {
    if (!weather) return;
    if (this.weather) {
      this.clearWeather();
    }
    this.weather = new Weather[weather](this.viewer);
    this.weather.init();
  }

  /**
   *
   * 清除天气
   * @memberof GisMap
   */
  clearWeather() {
    if (this.weather) {
      this.weather.destroy();
      this.weather = null;
    }
  }

  unHandleTip() {
    if (this.tip) {
      this.tip.destroy();
      this.tip = null;
      this.selected = null;
    }
  }

  handleTip(entity) {
    if (this.contextMenu) {
      this.contextMenu.hide();
    }
    // 单个tip展示
    if (this.tip &amp;&amp; this.selected &amp;&amp; this.selected.id === entity.id) {
      this.tip.show();
      console.log('已选中该对象');
    } else if (this.selected &amp;&amp; this.selected.id !== entity.id) {
      this.unHandleTip();
      this.selected = entity;
      this.tip = new Tip(this.viewer, entity);
    } else {
      this.selected = entity;
      this.tip = new Tip(this.viewer, entity);
    }
  }

  unHandleMenu() {
    if (this.contextMenu) {
      this.contextMenu.destroy();
      this.contextMenu = null;
      this.selected = null;
    }
  }

  handleMenu(entity) {
    if (this.tip) {
      this.tip.hide();
    }
    // 单个tip展示
    if (this.contextMenu &amp;&amp; this.selected &amp;&amp; this.selected.id === entity.id) {
      this.contextMenu.show();
      // console.log( this.contextMenu)
      console.log('已选中该对象');
    } else if (this.selected &amp;&amp; this.selected.id !== entity.id) {
      this.unHandleMenu();
      this.selected = entity;
      this.contextMenu = new Menu(this.viewer, entity);
    } else {
      this.selected = entity;
      this.contextMenu = new Menu(this.viewer, entity);
    }
  }

  drawPolyLine(points = [], options = {}) {
    const { width = 10, color = '#ff0000' } = options;

    if (points.length &lt; 2) {
      return;
    }

    const pointsArray = points.reduce((a, b) => a.concat(b), []);
    const poly = this.viewer.entities.add({
      polylineVolume: {
        positions: Cesium.Cartesian3.fromDegreesArrayHeights(
          pointsArray,
        ),
        shape: computeCircle(width, 15), // 参数是管线的半径，管线的横截面形状
        // material: Cesium.Color.fromCssColorString(color),
        material: new Cesium.PolylineMp(
          Cesium.Color.fromCssColorString(color || '#0099cc'),
          2000,
        ),
        // material: new Cesium.PolylineGlowMaterialProperty({
        //   color :new Cesium.Color.fromCssColorString(color||'#0099cc'),
        // }),
      },
    });

    return poly;
  }

  /**
   *
   * 移除元素
   * @param {string} id
   * @memberof GisMap
   */
  remove(entity) {
    let _entity = entity;
    if (typeof entity === 'string') {
      _entity = this.viewer.entities.getById(entity);
    }
    if (_entity) {
      this.viewer.entities.remove(_entity);
    }
  }

  test() {
    return this;
  }
}

GisMap.prototype.addCameraEvent = camera.addCameraEvent;
GisMap.prototype.removeCameraEvent = camera.removeCameraEvent;
GisMap.prototype.getCameraPosition = camera.getCameraPosition;
GisMap.prototype.getCameraHeight = camera.getCameraHeight;
// 鼠标事件

GisMap.prototype.addMouseEvent = mouse.addMouseEvent;
GisMap.prototype.removeMouseEvent = mouse.removeMouseEvent;
// 缩放
GisMap.prototype.zoomIn = base.zoomIn;
GisMap.prototype.zoomOut = base.zoomOut;
GisMap.prototype.setSceneMode2D3D = base.setSceneMode2D3D;

window.Cesium = Cesium;

export default GisMap;
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.10</a> on Mon May 30 2022 11:40:23 GMT+0800 (中国标准时间) using the Minami theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
