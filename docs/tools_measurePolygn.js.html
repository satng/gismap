<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>tools/measurePolygn.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <li class="nav-link nav-home-link"><a href="index.html">Home</a></li><li class="nav-heading">Classes</li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="GisMap.html">GisMap</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="GisMap.html#.addCameraEvent">addCameraEvent</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="GisMap.html#.addMouseEvent">addMouseEvent</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="GisMap.html#.canvas2image">canvas2image</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="GisMap.html#.clearSky">clearSky</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="GisMap.html#.cylinderWave">cylinderWave</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="GisMap.html#.drawAnimateLine">drawAnimateLine</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="GisMap.html#.drawCircle">drawCircle</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="GisMap.html#.drawCylinder">drawCylinder</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="GisMap.html#.drawEllipse">drawEllipse</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="GisMap.html#.drawFlashPoint">drawFlashPoint</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="GisMap.html#.drawFlashPointClock">drawFlashPointClock</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="GisMap.html#.drawImgPoint">drawImgPoint</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="GisMap.html#.drawLine">drawLine</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="GisMap.html#.drawPoint">drawPoint</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="GisMap.html#.drawPolygon">drawPolygon</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="GisMap.html#.drawRect">drawRect</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="GisMap.html#.getCameraHeight">getCameraHeight</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="GisMap.html#.getCameraPosition">getCameraPosition</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="GisMap.html#.removeCameraEvent">removeCameraEvent</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="GisMap.html#.removeMouseEvent">removeMouseEvent</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="GisMap.html#.resetSky">resetSky</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="GisMap.html#.setSceneMode2D3D">setSceneMode2D3D</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="GisMap.html#.setSky">setSky</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="GisMap.html#.zoomIn">zoomIn</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="GisMap.html#.zoomOut">zoomOut</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="GisMap.html#clearWeather">clearWeather</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="GisMap.html#destroy">destroy</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="GisMap.html#drawPolyLine">drawPolyLine</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="GisMap.html#remove">remove</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="GisMap.html#removeAll">removeAll</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="GisMap.html#setView">setView</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="GisMap.html#setWeather">setWeather</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="LoadCzml.html">LoadCzml</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="LoadCzml.html#bindStallite">bindStallite</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="LoadCzml.html#load">load</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="LoadCzml.html#remove">remove</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="LoadCzml.html#unbindStallite">unbindStallite</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="LoadCzml.LoadCzml.html">LoadCzml</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="MeasureLine.html">MeasureLine</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="MeasureLine.html#destroy">destroy</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="MeasureLine.html#finish">finish</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="MeasureLine.MeasureLine.html">MeasureLine</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="MeasurePolygn.html">MeasurePolygn</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="MeasurePolygn.html#destroy">destroy</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="MeasurePolygn.html#finish">finish</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="MeasurePolygn.MeasurePolygn.html">MeasurePolygn</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="SelectRect.html">SelectRect</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="SelectRect.html#finish">finish</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="SelectRect.SelectRect.html">SelectRect</a></span></li><li class="nav-heading"><a href="global.html">Globals</a></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#addCircleScanPostStage">addCircleScanPostStage</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#addRadarScanPostStage">addRadarScanPostStage</a></span></li>
</nav>

<div id="main">
    
    <h1 class="page-title">tools/measurePolygn.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/* eslint-disable no-param-reassign */
/* eslint-disable no-plusplus */
/* eslint-disable func-names */
import * as Cesium from 'cesium';

/**
 * 测量工具可选配配置项
 * @typedef {Object} MeasureOptions
 * @property {finishCallback} [onFinish] - 测量结束的的回调函数
 */

/**
 * 测量工具完成回调函数.
 * @callback finishCallback
 * @param {FinishData} finishData
 */

/**
 * FinishData 回调函数返回数据
 * @typedef {Object} FinishData
 * @property {numver} value - 测量距离长度 单位平方公里
 * @property {Object[]} points -测量绘制的坐标点
 */

const radiansPerDegree = Math.PI / 180.0;// 角度转化为弧度(rad)
const degreesPerRadian = 180.0 / Math.PI;// 弧度转化为角度
/* 方向 */
function Bearing(from, to) {
  const lat1 = from.lat * radiansPerDegree;
  const lon1 = from.lon * radiansPerDegree;
  const lat2 = to.lat * radiansPerDegree;
  const lon2 = to.lon * radiansPerDegree;
  let angle = -Math.atan2(Math.sin(lon1 - lon2) * Math.cos(lat2), Math.cos(lat1) * Math.sin(lat2) - Math.sin(lat1) * Math.cos(lat2) * Math.cos(lon1 - lon2));
  if (angle &lt; 0) {
    angle += Math.PI * 2.0;
  }
  angle *= degreesPerRadian;// 角度
  return angle;
}
/* 角度 */
function Angle(p1, p2, p3) {
  const bearing21 = Bearing(p2, p1);
  const bearing23 = Bearing(p2, p3);
  let angle = bearing21 - bearing23;
  if (angle &lt; 0) {
    angle += 360;
  }
  return angle;
}

function distance(point1, point2) {
  const point1cartographic = Cesium.Cartographic.fromCartesian(point1);
  const point2cartographic = Cesium.Cartographic.fromCartesian(point2);
  /** 根据经纬度计算出距离* */
  const geodesic = new Cesium.EllipsoidGeodesic();
  geodesic.setEndPoints(point1cartographic, point2cartographic);
  let s = geodesic.surfaceDistance;
  // 返回两点之间的距离
  s = Math.sqrt(s ** 2 + (point2cartographic.height - point1cartographic.height) ** 2);
  return s;
}

/**
 *
 * 面积测量工具 【单击鼠标左键绘制点，点击鼠标右键结束】
 * @class MeasurePolygn
 * @return {Object} measureInstance 测量工具实例
 */
class MeasurePolygn {
  /**
   * 实例测量工具
   * @param {MeasureOptions} [options={}]
   * @memberof MeasurePolygn
   */
  constructor(viewer, options = {}) {
    this.viewer = viewer;
    this.handler = new Cesium.ScreenSpaceEventHandler(viewer.scene._imageryLayerCollection);
    this.positions = [];
    this.tempPoints = [];
    this.poly = null;
    this.cartesian = null;
    // 浮动点
    this.floatingPoint = null;
    this.labelPt = null;
    this.polygon = null;
    this.onFinish = options.onFinish;
    this.PolygonPrimitive = function PolygonPrimitive(positions) {
      this.polygon = viewer.entities.add({
        polygon: {
          hierarchy: new Cesium.CallbackProperty(() => new Cesium.PolygonHierarchy(positions), false),
          material: Cesium.Color.GREEN.withAlpha(0.5),
        },
      });
    };
    viewer.scene.globe.depthTestAgainstTerrain = false;
    this.init(viewer);
  }

  init() {
    this.handleEvent();
  }

  getTerrainDistance(point1cartographic, point2cartographic) {
    const { viewer } = this;
    const geodesic = new Cesium.EllipsoidGeodesic();
    geodesic.setEndPoints(point1cartographic, point2cartographic);
    const s = geodesic.surfaceDistance;
    const cartoPts = [point1cartographic];
    for (let jj = 1000; jj &lt; s; jj += 1000) {
      // 分段采样计算距离
      const cartoPt = geodesic.interpolateUsingSurfaceDistance(jj);
      cartoPts.push(cartoPt);
    }
    cartoPts.push(point2cartographic);
    // 返回两点之间的距离
    const promise = Cesium.sampleTerrain(viewer.terrainProvider, 8, cartoPts);
    Promise.resolve(promise)
      .then((updatedPositions) => {
        for (let jj = 0; jj &lt; updatedPositions.length - 1; jj++) {
          const geoD = new Cesium.EllipsoidGeodesic();
          geoD.setEndPoints(updatedPositions[jj], updatedPositions[jj + 1]);
          let innerS = geoD.surfaceDistance;
          innerS = Math.sqrt(innerS ** 2 + (updatedPositions[jj + 1].height - updatedPositions[jj].height) ** 2);
          this.distance += innerS;
        }
        // 在三维场景中添加Label
        // const lon1 = viewer.scene.globe.ellipsoid.cartesianToCartographic(this.labelPt).longitude;
        // const lat1 = viewer.scene.globe.ellipsoid.cartesianToCartographic(this.labelPt).latitude;
        // const lonLat = `(${Cesium.Math.toDegrees(lon1).toFixed(2)},${Cesium.Math.toDegrees(lat1).toFixed(2)})`;
        // let textDisance = `${this.distance.toFixed(2)}米`;
        // if (this.distance > 10000) { textDisance = `${(this.distance / 1000.0).toFixed(2)}千米`; }
        this.floatingPoint = viewer.entities.add({
          name: '贴地距离',
          position: this.labelPt,
          point: {
            pixelSize: 5,
            color: Cesium.Color.RED,
            outlineColor: Cesium.Color.WHITE,
            outlineWidth: 2,
          },
        // label: {
        //   text: lonLat,
        //   font: '18px sans-serif',
        //   fillColor: Cesium.Color.GOLD,
        //   style: Cesium.LabelStyle.FILL_AND_OUTLINE,
        //   outlineWidth: 2,
        //   verticalOrigin: Cesium.VerticalOrigin.BOTTOM,
        //   pixelOffset: new Cesium.Cartesian2(20, -20),
        // },
        });
      });
  }

  // 空间两点距离计算函数
  getSpaceDistance($positions) {
    // 只计算最后一截，与前面累加
    // 因move和鼠标左击事件，最后两个点坐标重复
    const i = $positions.length - 3;
    const point1cartographic = Cesium.Cartographic.fromCartesian($positions[i]);
    const point2cartographic = Cesium.Cartographic.fromCartesian($positions[i + 1]);
    this.getTerrainDistance(point1cartographic, point2cartographic);
  }

  handleEvent() {
    const { viewer } = this;
    this.handler.setInputAction((movement) => {
      const ray = viewer.camera.getPickRay(movement.endPosition);
      this.cartesian = viewer.scene.globe.pick(ray, viewer.scene);
      // 跳出地球时异常
      if (!Cesium.defined(this.cartesian)) { return; }
      if (this.positions.length >= 2) {
        if (!Cesium.defined(this.poly)) {
          this.poly = new this.PolygonPrimitive(this.positions);
        } else {
          this.positions.pop();
          this.positions.push(this.cartesian);
        }
      }
    }, Cesium.ScreenSpaceEventType.MOUSE_MOVE);

    this.handler.setInputAction((movement) => {
      const ray = viewer.camera.getPickRay(movement.position);
      this.cartesian = viewer.scene.globe.pick(ray, viewer.scene);
      // 跳出地球时异常
      if (!Cesium.defined(this.cartesian)) { return; }
      if (this.positions.length === 0) {
        this.positions.push(this.cartesian.clone());
      }
      this.positions.push(this.cartesian);
      // 在三维场景中添加点
      const cartographic = Cesium.Cartographic.fromCartesian(this.positions[this.positions.length - 1]);
      const longitudeString = Cesium.Math.toDegrees(cartographic.longitude);
      const latitudeString = Cesium.Math.toDegrees(cartographic.latitude);
      const heightString = cartographic.height;
      this.tempPoints.push({ lon: longitudeString, lat: latitudeString, hei: heightString });
      // const labelText = `(${longitudeString.toFixed(2)},${latitudeString.toFixed(2)})`;
      this.labelPt = this.positions[this.positions.length - 1];
      if (this.positions.length > 2) {
        this.getSpaceDistance(this.positions);
      } else if (this.positions.length === 2) {
        // 在三维场景中添加Label
        this.floatingPoint = viewer.entities.add({
          name: '多边形面积',
          position: this.labelPt,
          point: {
            pixelSize: 5,
            color: Cesium.Color.RED,
            outlineColor: Cesium.Color.WHITE,
            outlineWidth: 2,
          },
          // label: {
          //   text: labelText,
          //   font: '18px sans-serif',
          //   fillColor: Cesium.Color.GOLD,
          //   style: Cesium.LabelStyle.FILL_AND_OUTLINE,
          //   outlineWidth: 2,
          //   verticalOrigin: Cesium.VerticalOrigin.BOTTOM,
          //   pixelOffset: new Cesium.Cartesian2(20, -20),
          // },
        });
      }
    }, Cesium.ScreenSpaceEventType.LEFT_CLICK);

    this.handler.setInputAction(() => {
      this.finish();
    }, Cesium.ScreenSpaceEventType.RIGHT_CLICK);
  }

  getArea(points) {
    let res = 0;
    // 拆分三角曲面
    for (let i = 0; i &lt; points.length - 2; i++) {
      const j = (i + 1) % points.length;
      const k = (i + 2) % points.length;
      const totalAngle = Angle(points[i], points[j], points[k]);
      const disTemp1 = distance(this.positions[i], this.positions[j]);
      const disTemp2 = distance(this.positions[j], this.positions[k]);
      res += disTemp1 * disTemp2 * Math.abs(Math.sin(totalAngle));
    }
    return (res / 1000000.0).toFixed(4);
  }

  /**
   *
   * 完成测量
   * @returns {'{points:any[],value:Number}'} data 返回数据 【value】为距离平方公里，【points】坐标点
   * @memberof MeasurePolygn
   */
  finish() {
    const { viewer } = this;
    this.handler.destroy(); // 关闭事件句柄
    this.handler = undefined;
    this.positions.pop(); // 最后一个点无效
    const area = this.getArea(this.tempPoints);
    const textArea = `${area}平方公里`;

    // let mid = new Cesium.Cartesian3();
    // console.log(555, this.positions);
    // mid = Cesium.Cartesian3.subtract(this.positions[Math.round(this.positions.length / 2) - 1], this.positions[this.positions.length - 1], mid);
    // console.log(mid);
    viewer.entities.add({
      name: '多边形面积',
      position: this.positions[this.positions.length - 1],
      label: {
        text: textArea,
        font: '18px sans-serif',
        fillColor: Cesium.Color.ALICEBLUE,
        style: Cesium.LabelStyle.FILL_AND_OUTLINE,
        outlineWidth: 2,
        verticalOrigin: Cesium.VerticalOrigin.BOTTOM,
        // pixelOffset: new Cesium.Cartesian3(0, 0, -100),
        eyeOffset: new Cesium.Cartesian3(0, 0, -200),
        heightReference: Cesium.HeightReference.CLAMP_TO_GROUND,
      },
    });
    const data = { points: this.positions, value: area };
    this.onFinish &amp;&amp; this.onFinish(data);
    return data;
  }

  /**
   *
   * 销毁测量工具
   * @memberof MeasurePolygn
   */
  destroy() {
    this.handler.destroy();
  }
}

export default MeasurePolygn;
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.10</a> on Tue Jun 21 2022 16:50:18 GMT+0800 (中国标准时间) using the Minami theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
